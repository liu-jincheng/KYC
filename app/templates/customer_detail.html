{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- 页面标题 -->
    <div class="col-12 mb-4">
        <div class="page-header">
            <nav aria-label="breadcrumb" class="mb-2">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/">首页</a></li>
                    <li class="breadcrumb-item"><a href="/customers">客户列表</a></li>
                    <li class="breadcrumb-item active">{{ customer.name }}</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <p class="text-uppercase text-muted small mb-1">客户档案</p>
                    <h2 class="mb-1"><i class="bi bi-person-circle me-1"></i> {{ customer.name }}</h2>
                    <p class="text-muted mb-0">
                        创建于 {{ customer.created_at.strftime('%Y-%m-%d %H:%M') if customer.created_at else '-' }}
                        {% if customer.updated_at %}
                        · 最后更新 {{ customer.updated_at.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                    </p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="/customers/{{ customer.id }}/edit" class="btn btn-info btn-icon px-3">
                        <i class="bi bi-pencil"></i> 编辑
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 状态流转 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="me-2">当前状态：</span>
                        <span class="badge fs-6 {{ 'bg-warning text-dark' if customer.status == '待录入' else 'bg-info' if customer.status == 'AI分析中' else 'bg-primary' if customer.status == '已出方案' else 'bg-secondary' if customer.status == '跟进中' else 'bg-success' }}">
                            {{ customer.status }}
                        </span>
                    </div>
                    <div class="btn-group">
                        {% for status in statuses %}
                        <button class="btn btn-sm {{ 'btn-primary' if customer.status == status else 'btn-outline-secondary' }} status-btn"
                                data-status="{{ status }}"
                                {% if customer.status == status %}disabled{% endif %}>
                            {{ status }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 左侧：KYC 档案 -->
    <div class="col-lg-5 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-person"></i> KYC 档案</h5>
            </div>
            <div class="card-body">
                {% if customer.kyc_data and form_schema %}
                {% for section in form_schema.sections %}
                <h6 class="text-primary border-bottom pb-2 mb-3">{{ section.title }}</h6>
                {% for field in section.fields %}
                {% set value = customer.kyc_data.get(field.name) %}
                {% if value %}
                <div class="row mb-2">
                    <div class="col-4 text-muted">{{ field.label }}</div>
                    <div class="col-8">
                        {% if value is iterable and value is not string %}
                        {{ value | join('、') }}
                        {% else %}
                        {{ value }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
                {% endfor %}
                {% else %}
                <p class="text-muted text-center py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    暂无 KYC 数据
                    <br>
                    <a href="/customers/{{ customer.id }}/edit" class="btn btn-primary btn-sm mt-3">
                        填写 KYC 表单
                    </a>
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- 右侧：AI 分析报告 -->
    <div class="col-lg-7 mb-4">
        <div class="card h-100 ai-report-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-file-earmark-richtext"></i> AI 分析报告</h5>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="showReportHistoryBtn" title="查看历史报告">
                        <i class="bi bi-clock-history"></i> <span id="reportHistoryCount" class="badge bg-secondary">0</span>
                    </button>
                    <button class="btn btn-sm btn-info" id="analyzeBtn" {% if customer.status == 'AI分析中' %}disabled{% endif %} title="点击生成AI分析报告">
                        <i class="bi bi-robot"></i> AI 智能生成
                    </button>
                </div>
            </div>
            <div class="card-body ai-report-body" id="aiReportBody">
                {% if customer.ai_report %}
                <div class="markdown-body" id="reportContent">
                    {{ customer.ai_report | markdown | safe }}
                </div>
                {% else %}
                <div id="reportPlaceholder">
                    <p class="text-muted text-center py-4">
                        <i class="bi bi-robot fs-1 d-block mb-2"></i>
                        暂无 AI 分析报告
                        <br>
                        {% if customer.kyc_data %}
                        <button class="btn btn-info btn-sm mt-3" id="generateReportBtn">
                            <i class="bi bi-robot"></i> 生成 AI 报告
                        </button>
                        {% else %}
                        <small>请先填写 KYC 表单</small>
                        {% endif %}
                    </p>
                </div>
                <div class="markdown-body" id="reportContent" style="display: none;"></div>
                {% endif %}
                
                <!-- AI 报告历史记录面板 -->
                <div class="accordion mt-3" id="reportHistoryAccordion" style="display: none;">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reportHistoryPanel" aria-expanded="false" aria-controls="reportHistoryPanel">
                                <i class="bi bi-clock-history me-2"></i>历史分析报告 <span id="reportHistoryBadge" class="badge bg-secondary ms-2">0</span>
                            </button>
                        </h2>
                        <div id="reportHistoryPanel" class="accordion-collapse collapse" data-bs-parent="#reportHistoryAccordion">
                            <div class="accordion-body p-2">
                                <div id="reportHistoryList" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                                    <p class="text-muted text-center py-2 mb-0">暂无历史记录</p>
                                </div>
                                <div id="reportHistoryActions" class="mt-2 text-end" style="display: none;">
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="clearReportHistoryBtn">
                                        <i class="bi bi-trash me-1"></i>清空历史
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 家庭与关系 -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> 家庭与关系</h5>
            </div>
            <div class="card-body">
                <!-- 子女信息 -->
                {% if customer.kyc_data and customer.kyc_data.get('children_count') %}
                <h6 class="text-primary">子女信息</h6>
                <p>
                    子女数量：{{ customer.kyc_data.get('children_count', 0) }} 人
                    {% if customer.kyc_data.get('children_education') %}
                    <br>教育阶段：{{ customer.kyc_data.get('children_education') | join('、') }}
                    {% endif %}
                </p>
                <hr>
                {% endif %}
                
                <!-- 关联人 -->
                <h6 class="text-primary">关联人</h6>
                {% if customer.related_contacts %}
                <ul class="list-group list-group-flush">
                    {% for contact in customer.related_contacts %}
                    <li class="list-group-item px-0">
                        <strong>{{ contact.name }}</strong>
                        {% if contact.relation %}
                        <span class="badge bg-secondary">{{ contact.relation }}</span>
                        {% endif %}
                        {% if contact.note %}
                        <br><small class="text-muted">{{ contact.note }}</small>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">暂无关联人记录</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- AI 商机挖掘 -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> AI 商机挖掘</h5>
            </div>
            <div class="card-body">
                {% if customer.ai_opportunities %}
                {% for opp in customer.ai_opportunities %}
                <div class="card mb-3 border-{{ 'danger' if opp.priority == 'high' else 'warning' if opp.priority == 'medium' else 'secondary' }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h6 class="card-title mb-1">
                                <i class="bi bi-{{ 'star-fill text-danger' if opp.priority == 'high' else 'star-half text-warning' if opp.priority == 'medium' else 'star' }}"></i>
                                {{ opp.type }}
                            </h6>
                            <span class="badge bg-{{ 'danger' if opp.priority == 'high' else 'warning text-dark' if opp.priority == 'medium' else 'secondary' }}">
                                {{ '高优先' if opp.priority == 'high' else '中优先' if opp.priority == 'medium' else '低优先' }}
                            </span>
                        </div>
                        <p class="card-text small text-muted mb-0">{{ opp.description }}</p>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted text-center py-4">
                    <i class="bi bi-lightbulb fs-1 d-block mb-2"></i>
                    暂无商机数据
                    <br>
                    <small>运行 AI 分析后将自动挖掘商机</small>
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 跟进信息 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-event"></i> 跟进信息</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label class="form-label">下次跟进日期</label>
                        <input type="date" class="form-control" id="followUpDate" 
                               value="{{ customer.next_follow_up.strftime('%Y-%m-%d') if customer.next_follow_up else '' }}">
                    </div>
                    <div class="col-md-6">
                        {% if customer.birthday %}
                        <div class="d-flex align-items-center gap-2">
                            <p class="mb-0">
                                <i class="bi bi-gift"></i> 生日：{{ customer.birthday.strftime('%Y-%m-%d') }}
                            </p>
                            <button class="btn btn-sm btn-outline-info" id="generateGreetingBtn" title="生成 AI 生日祝福">
                                <i class="bi bi-magic"></i> 生成祝福
                            </button>
                        </div>
                        {% else %}
                        <p class="text-muted mb-0">
                            <i class="bi bi-gift"></i> 未记录生日信息
                            <button class="btn btn-sm btn-link" data-bs-toggle="modal" data-bs-target="#birthdayModal">
                                添加
                            </button>
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 生日模态框 -->
<div class="modal fade" id="birthdayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">设置客户生日</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">生日日期</label>
                <input type="date" class="form-control" id="birthdayInput">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveBirthday">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 生日祝福生成 Modal -->
<div class="modal fade" id="birthdayGreetingModal" tabindex="-1" aria-labelledby="birthdayGreetingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="birthdayGreetingModalLabel">
                    <i class="bi bi-gift me-2"></i>生成生日祝福
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <!-- 客户信息 -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">客户姓名</label>
                    <div class="form-control-plaintext fs-5" id="greetingCustomerName">{{ customer.name }}</div>
                </div>
                
                <!-- 风格选择 -->
                <div class="mb-3">
                    <label for="greetingStyle" class="form-label fw-semibold">祝福风格</label>
                    <select class="form-select" id="greetingStyle">
                        <option value="商务专业" selected>商务专业 - 正式、得体</option>
                        <option value="温馨亲切">温馨亲切 - 友好、温暖</option>
                        <option value="幽默风趣">幽默风趣 - 轻松、有趣</option>
                        <option value="长辈尊享">长辈尊享 - 庄重、敬意</option>
                    </select>
                </div>
                
                <!-- 生成按钮 -->
                <div class="mb-3">
                    <button type="button" class="btn btn-info" id="doGenerateGreetingBtn">
                        <i class="bi bi-magic me-1"></i> 生成祝福
                    </button>
                </div>
                
                <!-- 结果区域 -->
                <div id="greetingResultArea" style="display: none;">
                    <hr>
                    <label class="form-label fw-semibold">生成的祝福语</label>
                    <div class="card bg-light">
                        <div class="card-body">
                            <pre id="greetingResult" class="mb-0" style="white-space: pre-wrap; font-family: inherit;"></pre>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" id="copyGreetingBtn">
                            <i class="bi bi-clipboard me-1"></i> 复制到剪贴板
                        </button>
                        <span id="copySuccess" class="text-success ms-2" style="display: none;">
                            <i class="bi bi-check-circle"></i> 已复制！
                        </span>
                    </div>
                </div>
                
                <!-- 加载状态 / 流式生成状态 -->
                <div id="greetingLoading" style="display: none;" class="text-center py-4">
                    <div class="spinner-border text-info spinner-border-sm" role="status">
                        <span class="visually-hidden">生成中...</span>
                    </div>
                    <span id="greetingStatusText" class="ms-2 text-info">AI 正在生成祝福语...</span>
                </div>
                
                <!-- 错误提示 -->
                <div id="greetingError" class="alert alert-danger" style="display: none;"></div>
                
                <!-- 历史记录区域 -->
                <div class="accordion mt-3" id="greetingHistoryAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#greetingHistoryPanel" aria-expanded="false" aria-controls="greetingHistoryPanel">
                                <i class="bi bi-clock-history me-2"></i>历史记录 <span id="historyCount" class="badge bg-secondary ms-2">0</span>
                            </button>
                        </h2>
                        <div id="greetingHistoryPanel" class="accordion-collapse collapse" data-bs-parent="#greetingHistoryAccordion">
                            <div class="accordion-body p-2">
                                <div id="greetingHistoryList" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                                    <p class="text-muted text-center py-2 mb-0">暂无历史记录</p>
                                </div>
                                <div id="historyActions" class="mt-2 text-end" style="display: none;">
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="clearHistoryBtn">
                                        <i class="bi bi-trash me-1"></i>清空历史
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const customerId = {{ customer.id }};

// 状态流转
document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const status = this.dataset.status;
        
        try {
            const response = await fetch(`/api/customers/${customerId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                alert('状态更新失败');
            }
        } catch (error) {
            console.error('更新失败:', error);
            alert('状态更新失败');
        }
    });
});

// AI 分析 - 流式输出版本
async function runAnalysis() {
    const btn = document.getElementById('analyzeBtn');
    const generateBtn = document.getElementById('generateReportBtn');
    const reportContent = document.getElementById('reportContent');
    const reportPlaceholder = document.getElementById('reportPlaceholder');
    
    // 禁用按钮并显示状态
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 生成中...';
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 生成中...';
    }
    
    // 隐藏占位符，显示内容区域
    if (reportPlaceholder) {
        reportPlaceholder.style.display = 'none';
    }
    if (reportContent) {
        reportContent.style.display = 'block';
        reportContent.innerHTML = '<p class="text-muted"><i class="bi bi-robot"></i> AI 正在分析中，请稍候...</p>';
    }
    
    let accumulatedText = '';
    
    try {
        // 使用 fetch 处理 SSE 流
        const response = await fetch(`/api/analyze/${customerId}/stream`, {
            method: 'POST',
            headers: {
                'Accept': 'text/event-stream'
            }
        });
        
        if (!response.ok) {
            let errorMsg = 'AI分析失败';
            try {
                const error = await response.json();
                errorMsg = error.detail || errorMsg;
            } catch (e) {
                errorMsg = `AI分析失败: HTTP ${response.status}`;
            }
            throw new Error(errorMsg);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        // 清空内容区域准备接收流式数据
        if (reportContent) {
            reportContent.innerHTML = '';
        }
        
        let buffer = '';
        
        // 添加流式光标效果
        if (reportContent) {
            reportContent.classList.add('streaming-cursor');
        }
        
        while (true) {
            const { done, value } = await reader.read();
            
            if (done) {
                console.log('流式传输完成');
                break;
            }
            
            buffer += decoder.decode(value, { stream: true });
            
            // 按行处理 SSE 数据
            const lines = buffer.split('\n');
            buffer = lines.pop() || ''; // 保留未完成的行
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const dataStr = line.slice(6).trim();
                    if (!dataStr || dataStr === '[DONE]') continue;
                    
                    try {
                        const data = JSON.parse(dataStr);
                        
                        if (data.type === 'content') {
                            // 接收到内容块
                            accumulatedText += data.content;
                            // 实时渲染 Markdown
                            if (reportContent) {
                                reportContent.innerHTML = renderMarkdown(accumulatedText);
                                // 滚动到底部
                                reportContent.scrollTop = reportContent.scrollHeight;
                            }
                        } else if (data.type === 'done') {
                            // 完成，移除光标效果
                            console.log('AI 分析完成');
                            if (reportContent) {
                                reportContent.classList.remove('streaming-cursor');
                            }
                            if (data.full_content) {
                                accumulatedText = data.full_content;
                                if (reportContent) {
                                    reportContent.innerHTML = renderMarkdown(accumulatedText);
                                }
                            }
                        } else if (data.type === 'error') {
                            // 错误
                            console.error('AI 分析错误:', data.message);
                            if (reportContent) {
                                reportContent.classList.remove('streaming-cursor');
                            }
                            throw new Error(data.message || 'AI分析出错');
                        }
                    } catch (e) {
                        if (e.message && !e.message.includes('JSON')) {
                            throw e; // 重新抛出非 JSON 解析错误
                        }
                        console.warn('解析 SSE 数据失败:', dataStr);
                    }
                }
            }
        }
        
        // 移除光标效果
        if (reportContent) {
            reportContent.classList.remove('streaming-cursor');
        }
        
        // 处理剩余的 buffer
        if (buffer.startsWith('data: ')) {
            const dataStr = buffer.slice(6).trim();
            if (dataStr && dataStr !== '[DONE]') {
                try {
                    const data = JSON.parse(dataStr);
                    if (data.type === 'content') {
                        accumulatedText += data.content;
                        if (reportContent) {
                            reportContent.innerHTML = renderMarkdown(accumulatedText);
                        }
                    }
                } catch (e) {
                    console.warn('解析最后的 SSE 数据失败:', dataStr);
                }
            }
        }
        
        console.log('分析完成，总内容长度:', accumulatedText.length);
        
        // 保存到历史记录
        if (accumulatedText) {
            saveReportToHistory(accumulatedText);
        }
        
        // 短暂延迟后刷新页面以确保数据库已更新
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('分析失败:', error);
        alert(`AI分析失败: ${error.message || '网络错误'}`);
        
        // 恢复占位符
        if (reportPlaceholder) {
            reportPlaceholder.style.display = 'block';
        }
        if (reportContent && !accumulatedText) {
            reportContent.style.display = 'none';
        }
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot"></i> AI 智能生成';
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="bi bi-robot"></i> 生成 AI 报告';
        }
    }
}

// 简单的 Markdown 渲染函数
function renderMarkdown(text) {
    if (!text) return '';
    
    // 转义 HTML
    let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    
    // 处理代码块
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
    
    // 处理行内代码
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // 处理标题
    html = html.replace(/^### (.+)$/gm, '<h5>$1</h5>');
    html = html.replace(/^## (.+)$/gm, '<h4>$1</h4>');
    html = html.replace(/^# (.+)$/gm, '<h3>$1</h3>');
    
    // 处理粗体和斜体
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    
    // 处理列表
    html = html.replace(/^\- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    
    // 处理有序列表
    html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
    
    // 处理换行
    html = html.replace(/\n\n/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    
    // 处理水平线
    html = html.replace(/---/g, '<hr>');
    
    return '<p>' + html + '</p>';
}

document.getElementById('analyzeBtn').addEventListener('click', runAnalysis);

const generateBtn = document.getElementById('generateReportBtn');
if (generateBtn) {
    generateBtn.addEventListener('click', runAnalysis);
}

// 跟进日期更新
const followUpDateInput = document.getElementById('followUpDate');
async function updateFollowUpDate(value) {
    try {
        await fetch(`/api/customers/${customerId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ next_follow_up: value || null })
        });
    } catch (error) {
        console.error('更新失败:', error);
    }
}

if (followUpDateInput) {
    // flatpickr 选择回调
    if (window.flatpickr) {
        flatpickr(followUpDateInput, {
            dateFormat: 'Y-m-d',
            defaultDate: followUpDateInput.value || undefined,
            locale: 'zh',
            allowInput: true,
            disableMobile: true,
            onChange: (selectedDates, dateStr) => updateFollowUpDate(dateStr)
        });
    }
    
    // 仍保留原生 change 以兼容未加载/不支持的情况
    followUpDateInput.addEventListener('change', function() {
        updateFollowUpDate(this.value);
    });
}

// 保存生日
const birthdayInput = document.getElementById('birthdayInput');
if (birthdayInput && window.flatpickr) {
    flatpickr(birthdayInput, {
        dateFormat: 'Y-m-d',
        defaultDate: birthdayInput.value || undefined,
        locale: 'zh',
        allowInput: true,
        disableMobile: true
    });
}

document.getElementById('saveBirthday').addEventListener('click', async function() {
    const birthday = document.getElementById('birthdayInput').value;
    
    try {
        const response = await fetch(`/api/customers/${customerId}/birthday`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ birthday: birthday || null })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('保存失败');
        }
    } catch (error) {
        console.error('保存失败:', error);
        alert('保存失败');
    }
});

// ============ 生日祝福生成功能 ============
let birthdayGreetingModal = null;

// 打开生日祝福 Modal
function openGreetingModal() {
    // 重置状态
    document.getElementById('greetingStyle').value = '商务专业';
    document.getElementById('greetingResultArea').style.display = 'none';
    document.getElementById('greetingLoading').style.display = 'none';
    document.getElementById('greetingError').style.display = 'none';
    document.getElementById('greetingResult').textContent = '';
    document.getElementById('doGenerateGreetingBtn').disabled = false;
    
    // 加载历史记录
    loadGreetingHistory();
    
    // 创建或显示 Modal
    if (!birthdayGreetingModal) {
        birthdayGreetingModal = new bootstrap.Modal(document.getElementById('birthdayGreetingModal'));
    }
    birthdayGreetingModal.show();
}

// 生成祝福 - 流式输出版本
async function generateGreeting() {
    const style = document.getElementById('greetingStyle').value;
    
    // 重置状态
    document.getElementById('greetingLoading').style.display = 'block';
    document.getElementById('greetingResultArea').style.display = 'block';
    document.getElementById('greetingResult').textContent = '';
    document.getElementById('greetingError').style.display = 'none';
    document.getElementById('doGenerateGreetingBtn').disabled = true;
    document.getElementById('greetingStatusText').textContent = 'AI 正在生成祝福语...';
    
    // 添加流式光标效果
    const resultElement = document.getElementById('greetingResult');
    resultElement.classList.add('streaming-cursor');
    
    let accumulatedContent = '';
    
    try {
        // 使用 fetch 处理 SSE 流
        const response = await fetch('/api/ai/generate-birthday-greeting/stream', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'text/event-stream'
            },
            body: JSON.stringify({
                customer_id: customerId,
                style: style
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
            const { done, value } = await reader.read();
            
            if (done) {
                console.log('流式传输完成');
                break;
            }
            
            buffer += decoder.decode(value, { stream: true });
            
            // 按行处理 SSE 数据
            while (buffer.includes('\n')) {
                const newlineIndex = buffer.indexOf('\n');
                const line = buffer.slice(0, newlineIndex).trim();
                buffer = buffer.slice(newlineIndex + 1);
                
                if (line.startsWith('data: ')) {
                    const dataStr = line.slice(6);
                    if (!dataStr || dataStr === '[DONE]') continue;
                    
                    try {
                        const data = JSON.parse(dataStr);
                        
                        if (data.type === 'content' && data.content) {
                            // 追加内容
                            accumulatedContent += data.content;
                            resultElement.textContent = accumulatedContent;
                            // 滚动到底部
                            resultElement.scrollTop = resultElement.scrollHeight;
                        } else if (data.type === 'done') {
                            // 完成
                            console.log('祝福语生成完成');
                            resultElement.classList.remove('streaming-cursor');
                            document.getElementById('greetingLoading').style.display = 'none';
                            // 如果有完整内容，使用完整内容
                            if (data.full_content) {
                                resultElement.textContent = data.full_content;
                                accumulatedContent = data.full_content;
                            }
                            // 保存到历史记录
                            if (accumulatedContent) {
                                saveGreetingToHistory(style, accumulatedContent);
                            }
                        } else if (data.type === 'error') {
                            // 错误
                            console.error('生成错误:', data.message);
                            resultElement.classList.remove('streaming-cursor');
                            document.getElementById('greetingError').textContent = data.message || '生成失败，请重试';
                            document.getElementById('greetingError').style.display = 'block';
                            if (!accumulatedContent) {
                                document.getElementById('greetingResultArea').style.display = 'none';
                            }
                        }
                    } catch (parseError) {
                        console.warn('解析 SSE 数据失败:', dataStr);
                    }
                }
            }
        }
        
        // 确保移除光标效果
        resultElement.classList.remove('streaming-cursor');
        
    } catch (error) {
        console.error('生成祝福失败:', error);
        resultElement.classList.remove('streaming-cursor');
        document.getElementById('greetingError').textContent = '网络错误，请检查连接后重试';
        document.getElementById('greetingError').style.display = 'block';
        if (!accumulatedContent) {
            document.getElementById('greetingResultArea').style.display = 'none';
        }
    } finally {
        document.getElementById('greetingLoading').style.display = 'none';
        document.getElementById('doGenerateGreetingBtn').disabled = false;
    }
}

// 复制祝福语到剪贴板
async function copyGreeting() {
    const greeting = document.getElementById('greetingResult').textContent;
    
    try {
        // 优先使用现代 API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(greeting);
        } else {
            // 降级方案
            const textarea = document.createElement('textarea');
            textarea.value = greeting;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        
        // 显示成功提示
        document.getElementById('copySuccess').style.display = 'inline';
        setTimeout(() => {
            document.getElementById('copySuccess').style.display = 'none';
        }, 2000);
        
    } catch (error) {
        console.error('复制失败:', error);
        alert('复制失败，请手动选择文本复制');
    }
}

// ============ 祝福历史记录管理 ============
const HISTORY_STORAGE_KEY = `birthday_greetings_history_${customerId}`;
const MAX_HISTORY_ITEMS = 10;

// 获取历史记录
function getGreetingHistory() {
    try {
        const data = localStorage.getItem(HISTORY_STORAGE_KEY);
        return data ? JSON.parse(data) : [];
    } catch (e) {
        console.error('读取历史记录失败:', e);
        return [];
    }
}

// 保存祝福到历史
function saveGreetingToHistory(style, content) {
    const history = getGreetingHistory();
    const newItem = {
        id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        style: style,
        content: content,
        timestamp: Date.now()
    };
    
    // 添加到开头
    history.unshift(newItem);
    
    // 限制最大数量
    if (history.length > MAX_HISTORY_ITEMS) {
        history.pop();
    }
    
    try {
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
        console.log('祝福已保存到历史记录');
        // 刷新历史列表显示
        loadGreetingHistory();
    } catch (e) {
        console.error('保存历史记录失败:', e);
    }
}

// 加载并显示历史记录
function loadGreetingHistory() {
    const history = getGreetingHistory();
    const listContainer = document.getElementById('greetingHistoryList');
    const countBadge = document.getElementById('historyCount');
    const actionsDiv = document.getElementById('historyActions');
    
    countBadge.textContent = history.length;
    
    if (history.length === 0) {
        listContainer.innerHTML = '<p class="text-muted text-center py-2 mb-0">暂无历史记录</p>';
        actionsDiv.style.display = 'none';
        return;
    }
    
    actionsDiv.style.display = 'block';
    
    let html = '';
    history.forEach(item => {
        const date = new Date(item.timestamp);
        const timeStr = date.toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        const snippet = item.content.length > 60 ? item.content.substring(0, 60) + '...' : item.content;
        
        html += `
            <div class="list-group-item list-group-item-action p-2" data-history-id="${item.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1" style="cursor: pointer;" onclick="useHistoryGreeting('${item.id}')">
                        <div class="d-flex gap-2 mb-1">
                            <span class="badge bg-info">${item.style}</span>
                            <small class="text-muted">${timeStr}</small>
                        </div>
                        <p class="mb-0 small text-muted" style="white-space: pre-wrap;">${snippet}</p>
                    </div>
                    <div class="btn-group btn-group-sm ms-2">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="copyHistoryGreeting('${item.id}')" title="复制">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteHistoryGreeting('${item.id}')" title="删除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    listContainer.innerHTML = html;
}

// 使用历史祝福（点击填充到结果区域）
function useHistoryGreeting(id) {
    const history = getGreetingHistory();
    const item = history.find(h => h.id === id);
    if (item) {
        document.getElementById('greetingResult').textContent = item.content;
        document.getElementById('greetingResultArea').style.display = 'block';
        document.getElementById('greetingStyle').value = item.style;
    }
}

// 复制历史祝福
async function copyHistoryGreeting(id) {
    const history = getGreetingHistory();
    const item = history.find(h => h.id === id);
    if (!item) return;
    
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(item.content);
        } else {
            const textarea = document.createElement('textarea');
            textarea.value = item.content;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        // 临时提示
        const btn = document.querySelector(`[data-history-id="${id}"] .btn-outline-success`);
        if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
        }
    } catch (e) {
        console.error('复制失败:', e);
    }
}

// 删除单条历史
function deleteHistoryGreeting(id) {
    let history = getGreetingHistory();
    history = history.filter(h => h.id !== id);
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
    loadGreetingHistory();
}

// 清空所有历史
function clearAllHistory() {
    if (confirm('确定要清空所有历史记录吗？')) {
        localStorage.removeItem(HISTORY_STORAGE_KEY);
        loadGreetingHistory();
    }
}

// 绑定生日祝福相关事件
const generateGreetingBtn = document.getElementById('generateGreetingBtn');
if (generateGreetingBtn) {
    generateGreetingBtn.addEventListener('click', openGreetingModal);
}

const doGenerateGreetingBtn = document.getElementById('doGenerateGreetingBtn');
if (doGenerateGreetingBtn) {
    doGenerateGreetingBtn.addEventListener('click', generateGreeting);
}

const copyGreetingBtn = document.getElementById('copyGreetingBtn');
if (copyGreetingBtn) {
    copyGreetingBtn.addEventListener('click', copyGreeting);
}

const clearHistoryBtn = document.getElementById('clearHistoryBtn');
if (clearHistoryBtn) {
    clearHistoryBtn.addEventListener('click', clearAllHistory);
}

// ============ AI 分析报告历史记录管理 ============
const REPORT_HISTORY_KEY = `ai_report_history_${customerId}`;
const MAX_REPORT_HISTORY = 10;

// 获取报告历史记录
function getReportHistory() {
    try {
        const data = localStorage.getItem(REPORT_HISTORY_KEY);
        return data ? JSON.parse(data) : [];
    } catch (e) {
        console.error('读取报告历史失败:', e);
        return [];
    }
}

// 保存报告到历史
function saveReportToHistory(content) {
    const history = getReportHistory();
    const newItem = {
        id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        content: content,
        timestamp: Date.now()
    };
    
    // 添加到开头
    history.unshift(newItem);
    
    // 限制最大数量
    if (history.length > MAX_REPORT_HISTORY) {
        history.pop();
    }
    
    try {
        localStorage.setItem(REPORT_HISTORY_KEY, JSON.stringify(history));
        console.log('AI报告已保存到历史记录');
        updateReportHistoryCount();
    } catch (e) {
        console.error('保存报告历史失败:', e);
    }
}

// 更新历史记录数量标记
function updateReportHistoryCount() {
    const history = getReportHistory();
    const countEl = document.getElementById('reportHistoryCount');
    const badgeEl = document.getElementById('reportHistoryBadge');
    if (countEl) countEl.textContent = history.length;
    if (badgeEl) badgeEl.textContent = history.length;
}

// 加载并显示报告历史记录
function loadReportHistory() {
    const history = getReportHistory();
    const listContainer = document.getElementById('reportHistoryList');
    const actionsDiv = document.getElementById('reportHistoryActions');
    const accordion = document.getElementById('reportHistoryAccordion');
    
    updateReportHistoryCount();
    
    if (history.length === 0) {
        listContainer.innerHTML = '<p class="text-muted text-center py-2 mb-0">暂无历史记录</p>';
        actionsDiv.style.display = 'none';
        return;
    }
    
    actionsDiv.style.display = 'block';
    accordion.style.display = 'block';
    
    let html = '';
    history.forEach((item, index) => {
        const date = new Date(item.timestamp);
        const timeStr = date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        // 截取内容预览（去除 markdown 标记）
        const plainText = item.content.replace(/[#*`\[\]\-_]/g, '').trim();
        const snippet = plainText.length > 80 ? plainText.substring(0, 80) + '...' : plainText;
        
        html += `
            <div class="list-group-item list-group-item-action p-2" data-report-id="${item.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1" style="cursor: pointer;" onclick="viewReportHistory('${item.id}')">
                        <div class="d-flex gap-2 mb-1 align-items-center">
                            <span class="badge bg-primary">第 ${history.length - index} 次分析</span>
                            <small class="text-muted">${timeStr}</small>
                        </div>
                        <p class="mb-0 small text-muted text-truncate" style="max-width: 400px;">${snippet}</p>
                    </div>
                    <div class="btn-group btn-group-sm ms-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewReportHistory('${item.id}')" title="查看">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="copyReportHistory('${item.id}')" title="复制">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteReportHistory('${item.id}')" title="删除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    listContainer.innerHTML = html;
}

// 查看历史报告（显示在主报告区域）
function viewReportHistory(id) {
    const history = getReportHistory();
    const item = history.find(h => h.id === id);
    if (!item) return;
    
    const reportContent = document.getElementById('reportContent');
    const reportPlaceholder = document.getElementById('reportPlaceholder');
    
    if (reportPlaceholder) {
        reportPlaceholder.style.display = 'none';
    }
    if (reportContent) {
        reportContent.style.display = 'block';
        reportContent.innerHTML = renderMarkdown(item.content);
        // 滚动到报告区域
        reportContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // 显示当前是历史报告的提示
    const date = new Date(item.timestamp);
    const timeStr = date.toLocaleString('zh-CN');
    showToast(`正在查看 ${timeStr} 生成的历史报告`, 'info');
}

// 复制历史报告
async function copyReportHistory(id) {
    const history = getReportHistory();
    const item = history.find(h => h.id === id);
    if (!item) return;
    
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(item.content);
        } else {
            const textarea = document.createElement('textarea');
            textarea.value = item.content;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        // 临时提示
        const btn = document.querySelector(`[data-report-id="${id}"] .btn-outline-success`);
        if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
        }
        showToast('报告已复制到剪贴板', 'success');
    } catch (e) {
        console.error('复制失败:', e);
        showToast('复制失败', 'danger');
    }
}

// 删除单条历史报告
function deleteReportHistory(id) {
    if (!confirm('确定要删除这条历史记录吗？')) return;
    
    let history = getReportHistory();
    history = history.filter(h => h.id !== id);
    localStorage.setItem(REPORT_HISTORY_KEY, JSON.stringify(history));
    loadReportHistory();
    showToast('已删除', 'success');
}

// 清空所有报告历史
function clearAllReportHistory() {
    if (confirm('确定要清空所有历史报告吗？此操作不可撤销。')) {
        localStorage.removeItem(REPORT_HISTORY_KEY);
        loadReportHistory();
        const accordion = document.getElementById('reportHistoryAccordion');
        if (accordion) accordion.style.display = 'none';
        showToast('历史记录已清空', 'success');
    }
}

// 显示/隐藏历史记录面板
function toggleReportHistoryPanel() {
    const accordion = document.getElementById('reportHistoryAccordion');
    const history = getReportHistory();
    
    if (history.length === 0) {
        showToast('暂无历史报告记录', 'info');
        return;
    }
    
    if (accordion.style.display === 'none') {
        accordion.style.display = 'block';
        loadReportHistory();
        // 展开手风琴
        const collapse = document.getElementById('reportHistoryPanel');
        const bsCollapse = new bootstrap.Collapse(collapse, { show: true });
    } else {
        accordion.style.display = 'none';
    }
}

// 简单的 Toast 提示函数
function showToast(message, type = 'info') {
    // 检查是否已存在 toast 容器
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '1100';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast_' + Date.now();
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    const toastEl = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 2000 });
    toast.show();
    
    // 清理已消失的 toast
    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}

// 绑定报告历史相关事件
const showReportHistoryBtn = document.getElementById('showReportHistoryBtn');
if (showReportHistoryBtn) {
    showReportHistoryBtn.addEventListener('click', toggleReportHistoryPanel);
}

const clearReportHistoryBtn = document.getElementById('clearReportHistoryBtn');
if (clearReportHistoryBtn) {
    clearReportHistoryBtn.addEventListener('click', clearAllReportHistory);
}

// 页面加载时初始化报告历史
document.addEventListener('DOMContentLoaded', function() {
    updateReportHistoryCount();
    const history = getReportHistory();
    if (history.length > 0) {
        const accordion = document.getElementById('reportHistoryAccordion');
        if (accordion) accordion.style.display = 'block';
        loadReportHistory();
    }
});
</script>
{% endblock %}

